var wt=Object.defineProperty;var Y=Object.getOwnPropertySymbols;var bt=Object.prototype.hasOwnProperty,xt=Object.prototype.propertyIsEnumerable;var W=(e,n,t)=>n in e?wt(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,Z=(e,n)=>{for(var t in n||(n={}))bt.call(n,t)&&W(e,t,n[t]);if(Y)for(var t of Y(n))xt.call(n,t)&&W(e,t,n[t]);return e};var tt=(e,n,t)=>(W(e,typeof n!="symbol"?n+"":n,t),t),et=(e,n,t)=>{if(!n.has(e))throw TypeError("Cannot "+t)};var m=(e,n,t)=>(et(e,n,"read from private field"),t?t.call(e):n.get(e)),x=(e,n,t)=>{if(n.has(e))throw TypeError("Cannot add the same private member more than once");n instanceof WeakSet?n.add(e):n.set(e,t)},S=(e,n,t,o)=>(et(e,n,"write to private field"),o?o.call(e,t):n.set(e,t),t);const At=function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function t(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerpolicy&&(s.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?s.credentials="include":i.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(i){if(i.ep)return;i.ep=!0;const s=t(i);fetch(i.href,s)}};At();const nt=document.createElement("template");nt.innerHTML=`
<style>
button {
    width: 1.5rem;
    height: 1.5rem;
}
</style>
<button></button>
`;var _;class ot extends HTMLElement{constructor(){super();x(this,_,void 0);const n=this.attachShadow({mode:"closed"});n.appendChild(nt.content.cloneNode(!0)),S(this,_,n.querySelector("button"))}static get observedAttributes(){return["value"]}attributeChangedCallback(n,t,o){n=="value"&&(m(this,_).style.background="#"+o)}}_=new WeakMap;window.customElements.define("p-color",ot);const it=document.createElement("template");it.innerHTML=`
<style>
:host {
    display: flex;
}

#current {
  position: relative;
  width: 4rem;
  height: 4rem;
}

#primary {
  position: absolute;
  top: .5rem;
  left: .5rem;
}

#secondary {
  position: absolute;
  top: 1.5rem;
  left: 1.5rem;
}

#available {
    display: flex;
    flex-direction: column;
    flex-wrap: wrap;
}
</style>
<div id="current">
    <p-color id="secondary" value="FFFFFF"></p-color>
    <p-color id="primary" value="000000"></p-color>
</div>
<div id="available">
    <slot></slot>
</div>
`;var $,H;class st extends HTMLElement{constructor(){super();x(this,$,void 0);x(this,H,void 0);const n=this.attachShadow({mode:"closed"});n.appendChild(it.content.cloneNode(!0)),S(this,$,n.querySelector("#primary")),S(this,H,n.querySelector("#secondary"))}static get observedAttributes(){return["primary","secondary"]}attributeChangedCallback(n,t,o){switch(n){case"primary":m(this,$).setAttribute("value",o);break;case"secondary":m(this,H).setAttribute("value",o);break}}}$=new WeakMap,H=new WeakMap;window.customElements.define("p-colors",st);const rt=document.createElement("template");rt.innerHTML=`
<style>
:host {
    position: absolute;
}

textarea {
    box-sizing: border-box;
    border: none;
    resize: none;
    outline: none;
    width: 100%;
    height: 100%;
}
</style>
<textarea></textarea>
`;function kt(e,n){var i;const t=document.createElement("span");t.style.font=n,t.textContent="A",(i=e.parentElement)==null||i.appendChild(t);const o=t.clientHeight;return t.remove(),o}function St(e,n,t,o){let i=o;const s=n.split(`
`).map(c=>c.split(" "));for(let c of s){let r="";for(let a of c){const l=r+a+" ";if(e.measureText(l).width<t){r=l;continue}e.fillText(r,0,i),r=a+" ",i+=o}e.fillText(r,0,i),i+=o}}var q,h,g,z,T,D;class ct extends HTMLElement{constructor(){super();x(this,q,void 0);x(this,h,void 0);x(this,g,void 0);tt(this,"value");x(this,z,"1.2rem Helvetica, Arial, Verdana sans-serif");x(this,T,"black");x(this,D,"white");S(this,q,this.attachShadow({mode:"closed"})),m(this,q).appendChild(rt.content.cloneNode(!0)),S(this,h,m(this,q).querySelector("textarea")),m(this,h).style.font=m(this,z),m(this,h).style.color=m(this,T),m(this,h).style.background=m(this,D),S(this,g,document.createElement("canvas"))}static get observedAttributes(){return["color","background"]}attributeChangedCallback(n,t,o){switch(n){case"color":S(this,T,o),m(this,h).style.color=o;break;case"background":S(this,D,o),m(this,h).style.background=o;break}}connectedCallback(){m(this,h).focus();const n=m(this,h).offsetWidth,t=m(this,h).offsetHeight;m(this,g).style.width=n+"px",m(this,g).style.height=t+"px",m(this,g).width=n,m(this,g).height=t,m(this,h).addEventListener("keyup",o=>{const i=kt(this,m(this,z)),s=m(this,g).getContext("2d");s.fillStyle=m(this,D),s.fillRect(0,0,n,t),s.fillStyle=m(this,T),s.font=m(this,z),St(s,m(this,h).value,n,i),this.value=s.getImageData(0,0,n,t)})}}q=new WeakMap,h=new WeakMap,g=new WeakMap,z=new WeakMap,T=new WeakMap,D=new WeakMap;window.customElements.define("p-text",ct);function at(e,n,t,o,i){const s=Math.sin(i),c=Math.cos(i);t-=e,o-=n;const r=t*c-o*s,a=t*s+o*c;return t=r+e,o=a+n,[t,o]}function gt(e,n,t,o,i){const s=Math.sqrt((t-e)**2+(o-n)**2);return Number.isNaN(s)||s<i?[NaN,NaN]:(e=t-i*(t-e)/s,n=o-i*(o-n)/s,[e,n])}function lt(e,n){return function(o,i,s){const c=n(i,s);if(c){const r=~(c>>24)&255,a=~(c>>16)&255,l=~(c>>8)&255,d=c&255,u=r*Math.pow(2,24)+a*Math.pow(2,16)+l*Math.pow(2,8)+d;e(u,i,s)}}}function vt(e,n,t,o,i,s,c=12,r=500){if([t,o]=gt(t,o,i,s,c),t&&o){const[a,l]=at(t,o,i,s,r),[d,u]=at(t,o,i,s,-r);O(e,n,Math.floor(a),Math.floor(l),i,s),O(e,n,Math.floor(d),Math.floor(u),i,s)}}function dt(e,n=8){const t=n*2;let o=0;return function(s,c,r){o<n&&e(s,c,r),o=(o+1)%t}}function Et(e,n,t,o,i){const s=n(o,i);if(s&&s!==t){const c=[[o,i]];for(let r=c.pop();r;r=c.pop())[o,i]=r,n(o,i)===s&&(e(t,o,i),c.push([o,i+1],[o,i-1],[o+1,i],[o-1,i]))}}function L(e,n){if(n===1)return e;if(n>1)return function(o,i,s){for(let c=0;c<n;c++)for(let r=0;r<n;r++)e(o,i+c,s+r)};throw new Error("Size must be greater than or equal 1")}function O(e,n,t,o,i,s){const c=Math.abs(i-t),r=t<i?1:-1,a=-Math.abs(s-o),l=o<s?1:-1;let d=c+a;for(;e(n,t,o),!(t==i&&o==s);){const u=2*d;u>=a&&(d+=a,t+=r),u<=c&&(d+=c,o+=l)}}function V(e,n,t,o,i,s){const c=Math.abs(t-i),r=Math.abs(o-s),a=t<i?t:i,l=o<s?o:s;for(let d=0;d<c;d++)for(let u=0;u<r;u++)e(n,a+d,l+u)}function N(e,n,t,o,i,s){const c=t<i?1:-1,r=o<s?1:-1;let a=t,l=o;for(;e(n,a,o),e(n,a,s),a!==i;)a+=c;for(;e(n,t,l),e(n,i,l),l!==s;)l+=r}let mt=2;const v={get sizes(){return[1,2,3,5]},get currentSize(){return mt},set currentSize(e){if(v.sizes.some(n=>n===e))mt=e;else throw new Error("Custom sizes not allowed")}};function Ft({buffer:e,colors:n,target:t}){let o,i,s;const c=a=>{e.unstash();let l=L(e.plot,v.currentSize);O(l,t.main?n.primary:n.secondary,o,i,t.x,t.y),vt(l,t.main?n.primary:n.secondary,o,i,t.x,t.y),e.commit(),s=window.requestAnimationFrame(c)};return Object.freeze({begin(){window.cancelAnimationFrame(s),e.stash(),L(e.plot,v.currentSize)(t.main?n.primary:n.secondary,t.x,t.y),o=t.x,i=t.y,e.commit(),s=window.requestAnimationFrame(c)},close(){window.cancelAnimationFrame(s),e.snapshot()},get modifiers(){return v.sizes.map(a=>({name:`${a}px`,isActive:a===v.currentSize,set(){v.currentSize=a}}))}})}function Lt({buffer:e,colors:n,target:t}){let o,i,s;const c=a=>{O(e.plot,t.secondary?n.secondary:n.primary,o,i,t.x,t.y),o=t.x,i=t.y,e.commit(),s=window.requestAnimationFrame(c)};return Object.freeze({begin(){window.cancelAnimationFrame(s),e.plot(t.secondary?n.secondary:n.primary,t.x,t.y),o=t.x,i=t.y,e.commit(),s=window.requestAnimationFrame(c)},close(){window.cancelAnimationFrame(s),e.snapshot()}})}const I=1<<0,P=1<<1,Ct=[{name:"outline",flags:I},{name:"full",flags:I|P},{name:"fill",flags:P}];let C=I;function Mt({buffer:e,colors:n,target:t}){let o,i,s;const c=a=>{if(e.unstash(),(P&C)>0&&V(e.plot,t.main?n.secondary:n.primary,o,i,t.x,t.y),(I&C)>0){let l=L(e.plot,v.currentSize);N(l,t.main?n.primary:n.secondary,o,i,t.x,t.y)}e.commit(),s=window.requestAnimationFrame(c)};return Object.freeze({begin(){window.cancelAnimationFrame(s),e.stash(),(P&C)>0&&e.plot(t.main?n.secondary:n.primary,t.x,t.y),(I&C)>0&&L(e.plot,v.currentSize)(t.main?n.primary:n.secondary,t.x,t.y),o=t.x,i=t.y,e.commit(),s=window.requestAnimationFrame(c)},close(){window.cancelAnimationFrame(s),e.snapshot()},get modifiers(){return Ct.map(({name:a,flags:l})=>({name:a,isActive:l===C,set(){C=l}}))}})}const ut=[2,3,5,7,9,11,13,15,17,19,21];let M=ut[0];document.addEventListener("wheel",({deltaY:e})=>{const n=Math.floor(M+e*.01);n>=2&&(M=n)});function jt({buffer:e,colors:n,target:t}){let o,i,s;const c=a=>{let l=L(e.plot,M);O(l,t.main?n.primary:n.secondary,o,i,t.x,t.y),o=t.x,i=t.y,e.commit(),s=window.requestAnimationFrame(c)};return Object.freeze({begin(){window.cancelAnimationFrame(s),L(e.plot,M)(t.main?n.primary:n.secondary,t.x,t.y),o=t.x,i=t.y,e.commit(),s=window.requestAnimationFrame(c)},close(){window.cancelAnimationFrame(s),e.snapshot()},get modifiers(){return ut.map(a=>({name:`${a}px`,isActive:a===M,set(){M=a}}))}})}function qt({buffer:e,colors:n,target:t}){return Object.freeze({begin(){},close(){const i=e.pick(t.x,t.y);i&&t.main&&(n.primary=i),i&&t.secondary&&(n.secondary=i)}})}function zt({buffer:e,colors:n,target:t}){return Object.freeze({begin(){},close(){Et(e.plot,e.pick,t.main?n.primary:n.secondary,t.x,t.y),e.commit(),e.snapshot()}})}function Tt({buffer:e,colors:n,target:t}){let o="select",i,s;const c=lt(dt(e.plot),e.pick);let r;const a=d=>{e.unstash(),N(c,n.primary,i,s,t.x,t.y),e.commit(),r=window.requestAnimationFrame(a)};return Object.freeze({begin(){o==="select"&&(window.cancelAnimationFrame(r),e.stash(),c(0,t.x,t.y),e.commit(),window.requestAnimationFrame(a)),i=t.x,s=t.y},close(){if(o==="select"){window.cancelAnimationFrame(r),o="edit",e.unstash();const{x:d,y:u,offsetLeft:f,offsetTop:y}=t,w=i<d?i:d,b=s<u?s:u,R=Math.abs(i-d),k=Math.abs(s-u);i=d,s=u,N(c,n.primary,w-1,b,w+R,b+k+1);const p=new ct;p.style.left=`${w+f}px`,p.style.top=`${b+y}px`,p.style.width=`${R}px`,p.style.height=`${k}px`;const K=t.main?n.primaryString:n.secondaryString,ft=t.main?n.secondaryString:n.primaryString;p.setAttribute("color",`#${K.substring(0,6)}`),p.setAttribute("background",`#${ft}`),document.body.appendChild(p),e.commit(),p.addEventListener("focusout",Bt=>{e.unstash(),p.remove(),p.value&&e.putImageData(p.value,w,b),e.commit(),e.snapshot(),o="done"})}else o==="done"&&(o="select")}})}function Dt(){let e;return[o=>{window.cancelAnimationFrame(e),e=window.requestAnimationFrame(function i(s){o(s),e=window.requestAnimationFrame(i)})},()=>{window.cancelAnimationFrame(e)}]}function Ot({buffer:e,colors:n,target:t}){let o="select",i,s,c,r,a;const[l,d]=Dt(),u=lt(dt(e.plot),e.pick),f=k=>{e.unstash(),N(u,n.primary,c,r,t.x,t.y),e.commit()},y=k=>{e.unstash(),V(e.plot,n.secondary,i.x,i.y,i.x+i.dx-1,i.y+i.dy-1),N(u,n.primary,s.x-1,s.y-1,s.x+s.dx,s.y+s.dy),e.putImageData(a,s.x,s.y),e.commit()},w=k=>{const p=c-t.x,K=r-t.y;c=t.x,r=t.y,s={x:s.x-p,y:s.y-K,dx:i.dx,dy:i.dy},y()},b=()=>s.x<t.x&&t.x<s.dx+s.x&&s.y<t.y&&t.y<s.dy+s.y;return Object.freeze({begin(){if(!(t.x<0||t.y<0)){switch(o){case"select":e.stash(),l(f);break;case"edit":b()?l(w):(d(),o="done",e.unstash(),V(e.plot,n.secondary,i.x,i.y,i.x+i.dx-1,i.y+i.dy-1),e.putImageData(a,s.x,s.y),e.commit());break}c=t.x,r=t.y}},close(){if(!(t.x<0||t.y<0))switch(o){case"select":o="edit";const{x:k,y:p}=t;i={x:c<k?c:k,y:r<p?r:p,dx:Math.abs(c-k),dy:Math.abs(r-p)},s=Z({},i),e.unstash(),a=e.getImageData(i.x,i.y,i.dx,i.dy),l(y);break;case"edit":l(y);break;case"done":o="select";break}}})}var Nt={createLine:Ft,createPencil:Lt,createBrush:jt,createRectangle:Mt,createPicker:qt,createBucket:zt,createText:Tt,createSelect:Ot};let G=255,J=4294967295;const U=new Set;function pt(){for(const e of U)e()}function ht(e){if(typeof e=="number")return e;if(typeof e=="string")return Number.parseInt(e,16);throw new Error("Not implemented")}const A={get colors(){return[255,4294967295,2155905279,3233857791,2147483903,4278190335,2155872511,4294902015,8388863,16711935,8421631,16777215,33023,65535,2147516671,4278255615,2155888895,4294934783,4210943,16744703,8454143,2164260863,4227327,2155937791,2147549183,4278223103,2151678207,4286595327]},get colorStrings(){return A.colors.map(e=>e.toString(16).padStart(8,"0"))},get primary(){return G},get secondary(){return J},get primaryString(){return G.toString(16).padStart(8,"0")},get secondaryString(){return J.toString(16).padStart(8,"0")},set primary(e){G=ht(e),pt()},set secondary(e){J=ht(e),pt()},subscribe(e){return U.add(e),U.delete.bind(U,e)}};function It(e){for(let n=0;n<e.length;n++)e[n]=255}function _t({width:e,height:n}){const t=new Set,o=new Uint8ClampedArray(e*n*4);It(o);const i=new Uint8ClampedArray(o),s=[new Uint8ClampedArray(o)],c=[];return Object.freeze({subscribe(r){return t.add(r),t.delete.bind(t,r)},plot(r,a,l){if(0>a||a>=e||0>l||l>=n)return;let d=a*4+l*e*4;o[d]=r>>24&255,o[++d]=r>>16&255,o[++d]=r>>8&255,o[++d]=r&255},pick(r,a){if(0>r||r>=e||0>a||a>=n)return;let l=r*4+a*e*4;return o[l]*Math.pow(2,24)+o[++l]*Math.pow(2,16)+o[++l]*Math.pow(2,8)+o[++l]},commit(){for(const r of t)r()},stash(){i.set(o)},unstash(){o.set(i)},snapshot(){c.length=0,s.push(new Uint8ClampedArray(o)),s.splice(0,s.length-50)},undo(){const r=s.pop();r&&(c.push(r),o.set(r))},redo(){const r=c.pop();r&&(s.push(r),o.set(r))},get imageData(){return new ImageData(o,e,n)},getImageData(r,a,l,d){const u=new Uint8ClampedArray(l*d*4);for(let f=0;f<d;f++){const y=r*4+(a+f)*e*4,w=(r+l)*4+(a+f)*e*4,b=f*l*4;u.set(o.slice(y,w),b)}return new ImageData(u,l,d)},putImageData(r,a,l){const d=a*4,u=l*e*4,f=r.width*4;for(let y=0;y<r.data.length;y++){const w=y%f,b=Math.floor(y/f)*e*4;o[d+u+w+b]=r.data[y]}}})}function $t({canvas:e}){let n,t,o,i,s;const c=r=>{t=r.button===0,o=r.button===2};return document.addEventListener("mousemove",({clientX:r,clientY:a})=>{i=r-e.offsetLeft,s=a-e.offsetTop}),document.addEventListener("mousedown",r=>{c(r),n.begin()}),document.addEventListener("mouseup",r=>{c(r),n.close()}),document.addEventListener("contextmenu",r=>r.preventDefault()),{get offsetLeft(){return e.offsetLeft},get offsetTop(){return e.offsetTop},get x(){return i},get y(){return s},get main(){return t},get secondary(){return o},set tool(r){n=r}}}const Q=1024,X=720,E=document.querySelector("canvas"),Ht=E.getContext("2d");E.style.width=Q+"px";E.style.height=X+"px";E.width=Q;E.height=X;const yt=$t({canvas:E}),F=_t({width:Q,height:X});F.subscribe(()=>Ht.putImageData(F.imageData,0,0));const Pt={buffer:F,colors:A,target:yt},Ut=document.getElementById("toolbox"),B=document.getElementById("toolbox-modifiers");for(const[e,n]of Object.entries(Nt)){const t=e.substr("create".length),o=document.createElement("button");o.innerText=t;const i=()=>{const s=n(Pt);for(yt.tool=s;B.firstChild;)B.removeChild(B.firstChild);if(s.modifiers)for(const c of s.modifiers){const r=document.createElement("button");r.innerText=c.name,r.addEventListener("click",c.set),B.appendChild(r)}};o.addEventListener("click",i),t==="Pencil"&&i(),Ut.appendChild(o)}const j=new st;j.setAttribute("primary",A.primaryString);j.setAttribute("secondary",A.secondaryString);for(const e of A.colorStrings){const n=new ot;n.setAttribute("value",e),n.addEventListener("click",t=>A.primary=n.getAttribute("value")),n.addEventListener("contextmenu",t=>{t.preventDefault(),A.secondary=n.getAttribute("value")}),j.appendChild(n)}A.subscribe(()=>{j.setAttribute("primary",A.primaryString),j.setAttribute("secondary",A.secondaryString)});document.querySelector("footer").appendChild(j);document.addEventListener("keydown",function(n){n.ctrlKey&&n.key==="z"&&(F.undo(),F.commit()),n.ctrlKey&&n.key==="r"&&(n.preventDefault(),F.redo(),F.commit()),n.ctrlKey&&n.key==="s"&&(n.preventDefault(),E.toBlob(function(o){const i=document.createElement("a");i.href=window.URL.createObjectURL(o),i.download="Untitled.bmp",i.click()},"image/bmp"))});
