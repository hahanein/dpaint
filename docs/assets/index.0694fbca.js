var ce=Object.defineProperty;var ae=(t,n,e)=>n in t?ce(t,n,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[n]=e;var V=(t,n,e)=>(ae(t,typeof n!="symbol"?n+"":n,e),e),G=(t,n,e)=>{if(!n.has(t))throw TypeError("Cannot "+e)};var m=(t,n,e)=>(G(t,n,"read from private field"),e?e.call(t):n.get(t)),w=(t,n,e)=>{if(n.has(t))throw TypeError("Cannot add the same private member more than once");n instanceof WeakSet?n.add(t):n.set(t,e)},v=(t,n,e,o)=>(G(t,n,"write to private field"),o?o.call(t,e):n.set(t,e),e);const le=function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerpolicy&&(r.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?r.credentials="include":i.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}};le();const J=document.createElement("template");J.innerHTML=`
<style>
button {
    width: 1.5rem;
    height: 1.5rem;
}
</style>
<button></button>
`;var T;class Q extends HTMLElement{constructor(){super();w(this,T,void 0);const n=this.attachShadow({mode:"closed"});n.appendChild(J.content.cloneNode(!0)),v(this,T,n.querySelector("button"))}static get observedAttributes(){return["value"]}attributeChangedCallback(n,e,o){n=="value"&&(m(this,T).style.background="#"+o)}}T=new WeakMap;window.customElements.define("p-color",Q);const X=document.createElement("template");X.innerHTML=`
<style>
:host {
    display: flex;
}

#current {
  position: relative;
  width: 4rem;
  height: 4rem;
}

#primary {
  position: absolute;
  top: .5rem;
  left: .5rem;
}

#secondary {
  position: absolute;
  top: 1.5rem;
  left: 1.5rem;
}

#available {
    display: flex;
    flex-direction: column;
    flex-wrap: wrap;
}
</style>
<div id="current">
    <p-color id="secondary" value="FFFFFF"></p-color>
    <p-color id="primary" value="000000"></p-color>
</div>
<div id="available">
    <slot></slot>
</div>
`;var z,N;class Y extends HTMLElement{constructor(){super();w(this,z,void 0);w(this,N,void 0);const n=this.attachShadow({mode:"closed"});n.appendChild(X.content.cloneNode(!0)),v(this,z,n.querySelector("#primary")),v(this,N,n.querySelector("#secondary"))}static get observedAttributes(){return["primary","secondary"]}attributeChangedCallback(n,e,o){switch(n){case"primary":m(this,z).setAttribute("value",o);break;case"secondary":m(this,N).setAttribute("value",o);break}}}z=new WeakMap,N=new WeakMap;window.customElements.define("p-colors",Y);const Z=document.createElement("template");Z.innerHTML=`
<style>
:host {
    position: absolute;
}

textarea {
    box-sizing: border-box;
    border: none;
    resize: none;
    outline: none;
    width: 100%;
    height: 100%;
}
</style>
<textarea></textarea>
`;function de(t,n){var i;const e=document.createElement("span");e.style.font=n,e.textContent="A",(i=t.parentElement)==null||i.appendChild(e);const o=e.clientHeight;return e.remove(),o}function me(t,n,e,o){let i=o;const r=n.split(`
`).map(c=>c.split(" "));for(let c of r){let s="";for(let a of c){const l=s+a+" ";if(t.measureText(l).width<e){s=l;continue}t.fillText(s,0,i),s=a+" ",i+=o}t.fillText(s,0,i),i+=o}}var C,h,y,j;class ee extends HTMLElement{constructor(){super();w(this,C,void 0);w(this,h,void 0);w(this,y,void 0);V(this,"value");w(this,j,"1.2rem Helvetica, Arial, Verdana sans-serif");v(this,C,this.attachShadow({mode:"closed"})),m(this,C).appendChild(Z.content.cloneNode(!0)),v(this,h,m(this,C).querySelector("textarea")),m(this,h).style.font=m(this,j),v(this,y,document.createElement("canvas"))}static get observedAttributes(){return[]}connectedCallback(){m(this,h).focus();const n=m(this,h).offsetWidth,e=m(this,h).offsetHeight;m(this,y).style.width=n+"px",m(this,y).style.height=e+"px",m(this,y).width=n,m(this,y).height=e,m(this,h).addEventListener("keyup",o=>{const i=de(this,m(this,j)),r=m(this,y).getContext("2d");r.font=m(this,j),me(r,m(this,h).value,n,i),this.value=r.getImageData(0,0,n,e),r.clearRect(0,0,n,e)})}}C=new WeakMap,h=new WeakMap,y=new WeakMap,j=new WeakMap;window.customElements.define("p-text",ee);function te(t,n,e,o,i){const r=Math.sin(i),c=Math.cos(i);e-=t,o-=n;const s=e*c-o*r,a=e*r+o*c;return e=s+t,o=a+n,[e,o]}function ue(t,n,e,o,i){const r=Math.sqrt((e-t)**2+(o-n)**2);return Number.isNaN(r)||r<i?[NaN,NaN]:(t=e-i*(e-t)/r,n=o-i*(o-n)/r,[t,n])}function pe(t,n,e,o,i,r,c=12,s=500){if([e,o]=ue(e,o,i,r,c),e&&o){const[a,l]=te(e,o,i,r,s),[d,u]=te(e,o,i,r,-s);M(t,n,Math.floor(a),Math.floor(l),i,r),M(t,n,Math.floor(d),Math.floor(u),i,r)}}function he(t,n=4){const e=n*2;let o=0;return function(r,c,s){o<n&&t(r,c,s),o=(o+1)%e}}function fe(t,n,e,o,i){const r=n(o,i);if(r&&r!==e){const c=[[o,i]];for(let s=c.pop();s;s=c.pop())[o,i]=s,n(o,i)===r&&(t(e,o,i),c.push([o,i+1],[o,i-1],[o+1,i],[o-1,i]))}}function k(t,n){if(n===1)return t;if(n>1)return function(o,i,r){for(let c=0;c<n;c++)for(let s=0;s<n;s++)t(o,i+c,r+s)};throw new Error("Size must be greater than or equal 1")}function M(t,n,e,o,i,r){const c=Math.abs(i-e),s=e<i?1:-1,a=-Math.abs(r-o),l=o<r?1:-1;let d=c+a;for(;t(n,e,o),!(e==i&&o==r);){const u=2*d;u>=a&&(d+=a,e+=s),u<=c&&(d+=c,o+=l)}}function ye(t,n,e,o,i,r){const c=Math.abs(e-i),s=Math.abs(o-r),a=e<i?e:i,l=o<r?o:r;for(let d=0;d<c;d++)for(let u=0;u<s;u++)t(n,a+d,l+u)}function P(t,n,e,o,i,r){const c=e<i?1:-1,s=o<r?1:-1;let a=e,l=o;for(;t(n,a,o),t(n,a,r),a!==i;)a+=c;for(;t(n,e,l),t(n,i,l),l!==r;)l+=s}let ne=2;const b={get sizes(){return[1,2,3,5]},get currentSize(){return ne},set currentSize(t){if(b.sizes.some(n=>n===t))ne=t;else throw new Error("Custom sizes not allowed")}};function we({buffer:t,colors:n,target:e}){let o,i,r;const c=a=>{t.unstash();let l=k(t.plot,b.currentSize);M(l,e.main?n.primary:n.secondary,o,i,e.x,e.y),pe(l,e.main?n.primary:n.secondary,o,i,e.x,e.y),t.commit(),r=window.requestAnimationFrame(c)};return Object.freeze({begin(){window.cancelAnimationFrame(r),t.stash(),k(t.plot,b.currentSize)(e.main?n.primary:n.secondary,e.x,e.y),o=e.x,i=e.y,t.commit(),r=window.requestAnimationFrame(c)},close(){window.cancelAnimationFrame(r),t.snapshot()},get modifiers(){return b.sizes.map(a=>({name:`${a}px`,isActive:a===b.currentSize,set(){b.currentSize=a}}))}})}function be({buffer:t,colors:n,target:e}){let o,i,r;const c=a=>{M(t.plot,e.secondary?n.secondary:n.primary,o,i,e.x,e.y),o=e.x,i=e.y,t.commit(),r=window.requestAnimationFrame(c)};return Object.freeze({begin(){window.cancelAnimationFrame(r),t.plot(e.secondary?n.secondary:n.primary,e.x,e.y),o=e.x,i=e.y,t.commit(),r=window.requestAnimationFrame(c)},close(){window.cancelAnimationFrame(r),t.snapshot()}})}const q=1<<0,D=1<<1,Ae=[{name:"outline",flags:q},{name:"full",flags:q|D},{name:"fill",flags:D}];let F=q;function ve({buffer:t,colors:n,target:e}){let o,i,r;const c=a=>{if(t.unstash(),(D&F)>0&&ye(t.plot,e.main?n.secondary:n.primary,o,i,e.x,e.y),(q&F)>0){let l=k(t.plot,b.currentSize);P(l,e.main?n.primary:n.secondary,o,i,e.x,e.y)}t.commit(),r=window.requestAnimationFrame(c)};return Object.freeze({begin(){window.cancelAnimationFrame(r),t.stash(),(D&F)>0&&t.plot(e.main?n.secondary:n.primary,e.x,e.y),(q&F)>0&&k(t.plot,b.currentSize)(e.main?n.primary:n.secondary,e.x,e.y),o=e.x,i=e.y,t.commit(),r=window.requestAnimationFrame(c)},close(){window.cancelAnimationFrame(r),t.snapshot()},get modifiers(){return Ae.map(({name:a,flags:l})=>({name:a,isActive:l===F,set(){F=l}}))}})}const oe=[2,3,5,7,9,11,13,15,17,19,21];let _=oe[0];function xe({buffer:t,colors:n,target:e}){let o,i,r;const c=a=>{let l=k(t.plot,_);M(l,e.main?n.primary:n.secondary,o,i,e.x,e.y),o=e.x,i=e.y,t.commit(),r=window.requestAnimationFrame(c)};return Object.freeze({begin(){window.cancelAnimationFrame(r),k(t.plot,_)(e.main?n.primary:n.secondary,e.x,e.y),o=e.x,i=e.y,t.commit(),r=window.requestAnimationFrame(c)},close(){window.cancelAnimationFrame(r),t.snapshot()},get modifiers(){return oe.map(a=>({name:`${a}px`,isActive:a===_,set(){_=a}}))}})}function Se({buffer:t,colors:n,target:e}){return Object.freeze({begin(){},close(){const i=t.pick(e.x,e.y);i&&e.main&&(n.primary=i),i&&e.secondary&&(n.secondary=i)}})}function ge({buffer:t,colors:n,target:e}){return Object.freeze({begin(){},close(){fe(t.plot,t.pick,e.main?n.primary:n.secondary,e.x,e.y),t.commit(),t.snapshot()}})}function Ee({buffer:t,colors:n,target:e}){let o="select",i,r;const c=he(t.plot);let s;const a=d=>{t.unstash(),P(c,n.primary,i,r,e.x,e.y),t.commit(),s=window.requestAnimationFrame(a)};return Object.freeze({begin(){o==="select"&&(window.cancelAnimationFrame(s),t.stash(),c(n.primary,e.x,e.y),t.commit(),window.requestAnimationFrame(a)),i=e.x,r=e.y},close(){if(o==="select"){window.cancelAnimationFrame(s),o="insert",t.unstash();const{x:d,y:u,offsetLeft:O,offsetTop:A}=e,g=i<d?i:d,E=r<u?r:u,K=Math.abs(i-d),W=Math.abs(r-u);i=d,r=u,P(c,n.primary,g-1,E,g+K,E+W+1);const f=new ee;f.style.left=`${g+O}px`,f.style.top=`${E+A}px`,f.style.width=`${K}px`,f.style.height=`${W}px`,document.body.appendChild(f),t.commit(),f.addEventListener("focusout",Te=>{t.unstash(),f.remove(),f.value&&t.putImageData(f.value,g,E),t.commit(),t.snapshot(),o="done"})}else o==="done"&&(o="select")}})}var ke={createLine:we,createPencil:be,createBrush:xe,createRectangle:ve,createPicker:Se,createBucket:ge,createText:Ee};let $=255,B=4294967295;const H=new Set;function ie(){for(const t of H)t()}function re(t){if(typeof t=="number")return t;if(typeof t=="string")return Number.parseInt(t,16);throw new Error("Not implemented")}const p={get colors(){return[255,4294967295,2155905279,3233857791,2147483903,4278190335,2155872511,4294902015,8388863,16711935,8421631,16777215,33023,65535,2147516671,4278255615,2155888895,4294934783,4210943,16744703,8454143,2164260863,4227327,2155937791,2147549183,4278223103,2151678207,4286595327]},get colorStrings(){return p.colors.map(t=>t.toString(16).padStart(8,"0"))},get primary(){return $},get secondary(){return B},get primaryString(){return $.toString(16).padStart(8,"0")},get secondaryString(){return B.toString(16).padStart(8,"0")},set primary(t){$=re(t),ie()},set secondary(t){B=re(t),ie()},subscribe(t){return H.add(t),H.delete.bind(H,t)}};function Fe(t){for(let n=0;n<t.length;n++)t[n]=255}function Le({width:t,height:n}){const e=new Set,o=new Uint8ClampedArray(t*n*4);Fe(o);const i=new Uint8ClampedArray(o),r=[new Uint8ClampedArray(o)],c=[];return Object.freeze({subscribe(s){return e.add(s),e.delete.bind(e,s)},plot(s,a,l){if(0>a||a>=t||0>l||l>=n)return;let d=a*4+l*t*4;o[d]=s>>24&255,o[++d]=s>>16&255,o[++d]=s>>8&255,o[++d]=s&255},pick(s,a){if(0>s||s>=t||0>a||a>=n)return;let l=s*4+a*t*4;return o[l]*Math.pow(2,24)+o[++l]*Math.pow(2,16)+o[++l]*Math.pow(2,8)+o[++l]},commit(){for(const s of e)s()},stash(){i.set(o)},unstash(){o.set(i)},snapshot(){c.length=0,r.push(new Uint8ClampedArray(o)),r.splice(0,r.length-50)},undo(){const s=r.pop();s&&(c.push(s),o.set(s))},redo(){const s=c.pop();s&&(r.push(s),o.set(s))},get imageData(){return new ImageData(o,t,n)},putImageData(s,a,l){const d=a*4,u=l*t*4,O=s.width*4;for(let A=0;A<s.data.length;A++){const g=A%O,E=Math.floor(A/O)*t*4;o[d+u+g+E]=s.data[A]}}})}function Ce({canvas:t}){let n,e,o,i,r;const c=s=>{e=s.button===0,o=s.button===2};return document.addEventListener("mousemove",({clientX:s,clientY:a})=>{i=s-t.offsetLeft,r=a-t.offsetTop}),document.addEventListener("mousedown",s=>{c(s),n.begin()}),document.addEventListener("mouseup",s=>{c(s),n.close()}),document.addEventListener("contextmenu",s=>s.preventDefault()),{get offsetLeft(){return t.offsetLeft},get offsetTop(){return t.offsetTop},get x(){return i},get y(){return r},get main(){return e},get secondary(){return o},set tool(s){n=s}}}const R=1024,U=720,x=document.querySelector("canvas"),je=x.getContext("2d");x.style.width=R+"px";x.style.height=U+"px";x.width=R;x.height=U;const se=Ce({canvas:x}),S=Le({width:R,height:U});S.subscribe(()=>je.putImageData(S.imageData,0,0));const Me={buffer:S,colors:p,target:se},qe=document.getElementById("toolbox"),I=document.getElementById("toolbox-modifiers");for(const[t,n]of Object.entries(ke)){const e=t.substr("create".length),o=document.createElement("button");o.innerText=e;const i=()=>{const r=n(Me);for(se.tool=r;I.firstChild;)I.removeChild(I.firstChild);if(r.modifiers)for(const c of r.modifiers){const s=document.createElement("button");s.innerText=c.name,s.addEventListener("click",c.set),I.appendChild(s)}};o.addEventListener("click",i),e==="Pencil"&&i(),qe.appendChild(o)}const L=new Y;L.setAttribute("primary",p.primaryString);L.setAttribute("secondary",p.secondaryString);for(const t of p.colorStrings){const n=new Q;n.setAttribute("value",t),n.addEventListener("click",e=>p.primary=n.getAttribute("value")),n.addEventListener("contextmenu",e=>{e.preventDefault(),p.secondary=n.getAttribute("value")}),L.appendChild(n)}p.subscribe(()=>{L.setAttribute("primary",p.primaryString),L.setAttribute("secondary",p.secondaryString)});document.querySelector("footer").appendChild(L);document.addEventListener("keydown",function(n){n.ctrlKey&&n.key==="z"&&(S.undo(),S.commit()),n.ctrlKey&&n.key==="r"&&(n.preventDefault(),S.redo(),S.commit()),n.ctrlKey&&n.key==="s"&&(n.preventDefault(),x.toBlob(function(o){const i=document.createElement("a");i.href=window.URL.createObjectURL(o),i.download="Untitled.bmp",i.click()},"image/bmp"))});
